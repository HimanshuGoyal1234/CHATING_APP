<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Create Account</title>
        <style>
            @keyframes shake {

                0%,
                100% {
                    transform: translateX(0);
                }

                20%,
                60% {
                    transform: translateX(-5px);
                }

                40%,
                80% {
                    transform: translateX(5px);
                }
            }

            body {
                font-family: 'Segoe UI', Arial, sans-serif;
                background: linear-gradient(216deg, rgba(77, 77, 77, 0.05) 0%, rgba(77, 77, 77, 0.05) 25%, rgba(42, 42, 42, 0.05) 25%, rgba(42, 42, 42, 0.05) 38%, rgba(223, 223, 223, 0.05)38%, rgba(223, 223, 223, 0.05) 75%, rgba(36, 36, 36, 0.05) 75%, rgba(36, 36, 36, 0.05)100%), linear-gradient(44deg, rgba(128, 128, 128, 0.05) 0%, rgba(128, 128, 128, 0.05) 34%, rgba(212, 212, 212, 0.05) 34%, rgba(212, 212, 212, 0.05) 57%, rgba(25, 25, 25, 0.05) 57%, rgba(25, 25, 25, 0.05) 89%, rgba(135, 135, 135, 0.05) 89%, rgba(135, 135, 135, 0.05) 100%), linear-gradient(241deg, rgba(55, 55, 55, 0.05) 0%, rgba(55, 55, 55, 0.05) 14%, rgba(209, 209, 209, 0.05) 14%, rgba(209, 209, 209, 0.05) 60%, rgba(245, 245, 245, 0.05) 60%, rgba(245, 245, 245, 0.05) 69%, rgba(164, 164, 164, 0.05) 69%, rgba(164, 164, 164, 0.05)100%), linear-gradient(249deg, rgba(248, 248, 248, 0.05) 0%, rgba(248, 248, 248, 0.05) 32%, rgba(148, 148, 148, 0.05) 32%, rgba(148, 148, 148, 0.05) 35%, rgba(202, 202, 202, 0.05) 35%, rgba(202, 202, 202, 0.05)51%, rgba(181, 181, 181, 0.05) 51%, rgba(181, 181, 181, 0.05) 100%), linear-gradient(92deg, hsl(214, 0%, 11%), hsl(214, 0%, 11%));
                color: #ffffff;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
            }

            .create-account-container {
                text-align: center;
                background-color: #1e1e1e;
                padding: 30px 40px;
                border-radius: 12px;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
                width: 320px;
                transition: all 0.3s ease;
            }

            .shake {
                animation: shake 0.4s;
            }

            h1 {
                color: #bb86fc;
                margin-bottom: 24px;
                font-weight: 500;
            }

            .input-group {
                margin-bottom: 20px;
                text-align: left;
                position: relative;
            }

            label {
                display: block;
                margin-bottom: 8px;
                color: #9e9e9e;
                font-size: 14px;
            }

            input[type="text"],
            input[type="password"] {
                width: 100%;
                padding: 12px 12px;
                border-radius: 6px;
                border: 1px solid #333;
                background-color: #2d2d2d;
                color: #ffffff;
                box-sizing: border-box;
                font-size: 15px;
                transition: border-color 0.3s;
            }

            input:focus {
                outline: 2px solid #bb86fc;
                outline-offset: -1px;
            }

            .btn {
                background-color: #bb86fc;
                color: white;
                border: none;
                padding: 14px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 15px;
                width: 100%;
                font-weight: 500;
                margin-bottom: 12px;
                transition: all 0.2s;
            }

            .btn:hover {
                background-color: #9a67ea;
            }

            .btn:disabled {
                background-color: #6d4b9e;
                cursor: not-allowed;
                opacity: 0.7;
            }

            .login-btn {
                background-color: transparent;
                border: 1px solid #bb86fc;
                color: #bb86fc;
            }

            .login-btn:hover {
                background-color: rgba(187, 134, 252, 0.1);
            }

            .error-message {
                color: #ff5555;
                padding: 8px 0;
                margin: -8px 0 12px 0;
                font-size: 14px;
                opacity: 0;
                height: 20px;
                transition: opacity 0.3s;
                text-align: left;
            }

            .error-message.visible {
                opacity: 1;
            }

            .success-message {
                color: #03dac6;
                padding: 8px 0;
                margin: -8px 0 12px 0;
                font-size: 14px;
                opacity: 0;
                height: 20px;
                transition: opacity 0.3s;
                text-align: center;
            }

            .success-message.visible {
                opacity: 1;
            }

            .password-strength {
                height: 4px;
                background: #2d2d2d;
                margin-top: 8px;
                border-radius: 2px;
                overflow: hidden;
            }

            .strength-meter {
                height: 100%;
                width: 0%;
                transition: width 0.3s, background 0.3s;
            }

            .password-requirements {
                color: #9e9e9e;
                font-size: 12px;
                text-align: left;
                margin-top: 4px;
            }

            .requirement {
                display: flex;
                align-items: center;
                margin-bottom: 4px;
            }

            .requirement::before {
                content: "•";
                margin-right: 6px;
                color: #9e9e9e;
            }

            .requirement.valid::before {
                color: #03dac6;
                content: "✓";
            }

            /* New styles for password toggle */
            .password-toggle {
                transform: translate(0px, -26px);
                position: absolute;
                right: 10px;
                top: 35px;
                background: none;
                border: none;
                color: #6d4b9e;
                cursor: pointer;
                font-size: 18px;

            }

            .password-input-container {
                position: relative;
            }
        </style>
    </head>

    <body>
        <div class="create-account-container" id="account-container">
            <h1>Create Account</h1>
            <form id="accountForm">
                <div class="input-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required minlength="4" maxlength="20">
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <div class="password-input-container">
                        <input type="password" id="password" name="password" required minlength="8">
                        <button type="button" class="password-toggle" id="togglePassword">show</button>
                    </div>
                    <div class="password-strength">
                        <div class="strength-meter" id="strength-meter"></div>
                    </div>
                    <div class="password-requirements">
                        <div class="requirement" id="length-req">At least 8 characters</div>
                        <div class="requirement" id="number-req">Contains a number</div>
                        <div class="requirement" id="special-req">Contains a special character</div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="confirm-password">Confirm Password</label>
                    <div class="password-input-container">
                        <input type="password" id="confirm-password" name="confirm-password" required>
                        <button type="button" class="password-toggle" id="toggleConfirmPassword">show</button>
                    </div>
                </div>

                <div class="error-message" id="error-message"></div>
                <div class="success-message" id="success-message"></div>

                <button type="submit" class="btn" id="submit-btn">Create Account</button>
            </form>
            <button class="btn login-btn" onclick="window.location.href='login.html'">Already have an account?
                Login</button>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const form = document.getElementById("accountForm");
                const usernameInput = document.getElementById("username");
                const passwordInput = document.getElementById("password");
                const confirmPasswordInput = document.getElementById("confirm-password");
                const errorMessage = document.getElementById("error-message");
                const successMessage = document.getElementById("success-message");
                const submitBtn = document.getElementById("submit-btn");
                const accountContainer = document.getElementById("account-container");
                const strengthMeter = document.getElementById("strength-meter");
                const togglePassword = document.getElementById("togglePassword");
                const toggleConfirmPassword = document.getElementById("toggleConfirmPassword");

                // Password strength indicators
                const lengthReq = document.getElementById("length-req");
                const numberReq = document.getElementById("number-req");
                const specialReq = document.getElementById("special-req");

                // Invalid characters pattern (including spaces)
                const INVALID_CHARS = /[\/\\:*?"<>|\s]/;
                const USERNAME_INVALID_CHARS = /[\/\\:*?"<>|\s@]/; // @ is also invalid for username

                // Password visibility toggle
                togglePassword.addEventListener('click', () => {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    togglePassword.textContent = type === 'password' ? 'show' : 'hide';
                });

                toggleConfirmPassword.addEventListener('click', () => {
                    const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    confirmPasswordInput.setAttribute('type', type);
                    toggleConfirmPassword.textContent = type === 'password' ? 'show' : 'hide';
                });

                // Password strength checker
                passwordInput.addEventListener('input', () => {
                    const password = passwordInput.value;
                    let strength = 0;

                    // Check length
                    if (password.length >= 8) {
                        strength += 1;
                        lengthReq.classList.add('valid');
                    } else {
                        lengthReq.classList.remove('valid');
                    }

                    // Check for numbers
                    if (/\d/.test(password)) {
                        strength += 1;
                        numberReq.classList.add('valid');
                    } else {
                        numberReq.classList.remove('valid');
                    }

                    // Check for special chars (but not invalid ones)
                    if (/[!@#$%^&(),.?;{ }=+_\-~`]/.test(password) && !INVALID_CHARS.test(password)) {
                        strength += 1;
                        specialReq.classList.add('valid');
                    } else {
                        specialReq.classList.remove('valid');
                    }

                    // Update strength meter
                    const width = (strength / 3) * 100;
                    strengthMeter.style.width = `${ width }%`;

                    // Update color based on strength
                    if (strength === 0) {
                        strengthMeter.style.backgroundColor = '#ff5555';
                    } else if (strength === 1) {
                        strengthMeter.style.backgroundColor = '#ff9e22';
                    } else if (strength === 2) {
                        strengthMeter.style.backgroundColor = '#ffd700';
                    } else {
                        strengthMeter.style.backgroundColor = '#03dac6';
                    }
                });

                // Username validation on input
                usernameInput.addEventListener('input', () => {
                    const username = usernameInput.value;
                    if (USERNAME_INVALID_CHARS.test(username)) {
                        showError("Username contains invalid characters (/\\:*?\"<>|@ or spaces)");
                    } else {
                        errorMessage.classList.remove("visible");
                    }
                });

                form.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    // Reset messages
                    errorMessage.textContent = "";
                    errorMessage.classList.remove("visible");
                    successMessage.textContent = "";
                    successMessage.classList.remove("visible");

                    const username = usernameInput.value.trim();
                    const password = passwordInput.value.trim();
                    const confirmPassword = confirmPasswordInput.value.trim();

                    // Client-side validation
                    if (USERNAME_INVALID_CHARS.test(username)) {
                        showError("Username contains invalid characters (/\\:*?\"<>|@ or spaces)");
                        accountContainer.classList.add("shake");
                        setTimeout(() => accountContainer.classList.remove("shake"), 400);
                        return;
                    }

                    if (username.length < 4) {
                        showError("Username must be at least 4 characters");
                        return;
                    }

                    if (password !== confirmPassword) {
                        showError("Passwords do not match");
                        accountContainer.classList.add("shake");
                        setTimeout(() => accountContainer.classList.remove("shake"), 400);
                        return;
                    }

                    if (password.length < 8) {
                        showError("Password must be at least 8 characters");
                        return;
                    }

                    // Check for invalid characters in password
                    if (INVALID_CHARS.test(password)) {
                        showError("Password contains invalid characters (/\\:*?\"<>| or spaces)");
                        accountContainer.classList.add("shake");
                        setTimeout(() => accountContainer.classList.remove("shake"), 400);
                        return;
                    }

                    // Show loading state
                    submitBtn.disabled = true;
                    submitBtn.textContent = "Creating account...";

                    try {
                        const res = await fetch("/create-account", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ username, password })
                        });

                        const data = await res.json();

                        if (res.ok) {
                            showSuccess("Account created successfully!");
                            setTimeout(() => {
                                if (data.redirect) {
                                    window.location.href = data.redirect;
                                }
                            }, 1500);
                        } else {
                            showError(data.error || "Failed to create account. Please try again.");
                            accountContainer.classList.add("shake");
                            setTimeout(() => accountContainer.classList.remove("shake"), 400);
                        }
                    } catch (err) {
                        showError("Network error. Please try again.");
                        accountContainer.classList.add("shake");
                        setTimeout(() => accountContainer.classList.remove("shake"), 400);
                        console.error("Account creation error:", err);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Create Account";
                    }
                });

                function showError(message) {
                    errorMessage.textContent = message;
                    errorMessage.classList.add("visible");
                }

                function showSuccess(message) {
                    successMessage.textContent = message;
                    successMessage.classList.add("visible");
                }
            });
        </script>
    </body>

</html>